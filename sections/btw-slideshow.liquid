{{ 'btw-slideshow.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign slide_count = 0
  for block in section.blocks
    if block.type == '_slide'
      assign slide_count = slide_count | plus: 1
    endif
  endfor
-%}

{% if slide_count > 1 %}
  {% capture controls %}
    {%- render 'slideshow-controls',
      style: section.settings.slideshow_controls_style,
      autoplay: section.settings.autoplay,
      item_count: slide_count,
      show_arrows: false,
      arrows_on_media: true,
      controls_on_media: true,
      pagination_position: 'center',
      icon_style: section.settings.icons_style
    -%}
  {% endcapture %}
{% endif %}

{%- comment -%} Catturo SOLO gli slide {%- endcomment -%}
{% capture slides %}
  {% for block in section.blocks %}
    {% if block.type == '_slide' %}
      {% render block %}
    {% endif %}
  {% endfor %}
{% endcapture %}

{%- comment -%} Catturo i gruppi da rendere in section {%- endcomment -%}
{% capture btw_groups %}
  {% for block in section.blocks %}
    {% if block.type == '_btw-group' %}
      {% render block %}
    {% endif %}
  {% endfor %}
{% endcapture %}

{% liquid
  assign slideshow_class = 'slideshow--single-media'
  if slide_count > 1
    assign slideshow_class = ''
  endif

  assign show_arrows = true
  if section.settings.icons_style == 'none' or slide_count <= 1
    assign show_arrows = false
  endif
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="spacing-style section section--{{ section.settings.section_width }} color-{{ section.settings.color_scheme }} disable-section-top-offset"
  style="{% render 'spacing-padding', settings: section.settings %}"
>

  {%- if section.settings.slide_height == 'auto' -%}
    <div id="Slideshow-{{ section.id }}" class="{{ section.settings.section_width }}">
      {% render 'slideshow',
        class: slideshow_class,
        controls: controls,
        show_arrows: show_arrows,
        icon_style: section.settings.icons_style,
        autoplay: section.settings.autoplay,
        autoplay_speed: section.settings.autoplay_speed,
        slides: slides,
        slide_count: slide_count,
        slide_size: section.settings.slide_height
      %}
    </div>

    <style>
      /* L’altezza del wrapper segue il rapporto d’aspetto della prima immagine/video */
      #Slideshow-{{ section.id }},
      #Slideshow-{{ section.id }} slideshow-slides {
        aspect-ratio: var(--slide-aspect-ratio, 16/9); /* fallback iniziale */
      }

      /* Assicura che il contenuto riempia l’altezza calcolata */
      #Slideshow-{{ section.id }} slideshow-container,
      #Slideshow-{{ section.id }} slideshow-slides {
        height: 100%;
      }
      #Slideshow-{{ section.id }} img,
      #Slideshow-{{ section.id }} video {
        width: 100%;
        height: 100%;
        object-fit: cover; /* usa 'contain' se non vuoi crop */
      }

      /* Fallback per browser senza aspect-ratio */
      @supports not (aspect-ratio: 1 / 1) {
        #Slideshow-{{ section.id }} { position: relative; }
        #Slideshow-{{ section.id }}::before {
          content: "";
          display: block;
          padding-top: var(--slide-padding-top, 56.25%); /* aggiornato via JS */
        }
        #Slideshow-{{ section.id }} > * {
          position: absolute;
          inset: 0;
          height: 100%;
          width: 100%;
        }
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var root = document.getElementById('Slideshow-{{ section.id }}');
        if (!root) return;

        // Cerca il primo media reale dentro <slideshow-slides> per evitare icone/controlli
        var media = root.querySelector('slideshow-slides img, slideshow-slides video');
        if (!media) return;

        function setRatio(w, h) {
          if (w && h) {
            root.style.setProperty('--slide-aspect-ratio', w + ' / ' + h);
            // Fallback per browser senza aspect-ratio:
            root.style.setProperty('--slide-padding-top', (h / w * 100) + '%');
          }
        }

        if (media.tagName === 'IMG') {
          if (media.complete && media.naturalWidth) {
            setRatio(media.naturalWidth, media.naturalHeight);
          } else {
            media.addEventListener('load', function () {
              setRatio(media.naturalWidth, media.naturalHeight);
            }, { once: true });
          }
        } else if (media.tagName === 'VIDEO') {
          if (media.readyState >= 1 && media.videoWidth) {
            setRatio(media.videoWidth, media.videoHeight);
          } else {
            media.addEventListener('loadedmetadata', function () {
              setRatio(media.videoWidth, media.videoHeight);
            }, { once: true });
          }
        }
      });
    </script>

  {%- else -%}
    <style>
      /* Comportamento nativo del tema quando height = full */
      #Slideshow-{{ section.id }} slideshow-slides[size=full] {
        height: calc(100vh - var(--header-group-height));
      }
    </style>
    <div id="Slideshow-{{ section.id }}" class="{{ section.settings.section_width }}">
      {% render 'slideshow',
        class: slideshow_class,
        controls: controls,
        show_arrows: show_arrows,
        icon_style: section.settings.icons_style,
        autoplay: section.settings.autoplay,
        autoplay_speed: section.settings.autoplay_speed,
        slides: slides,
        slide_count: slide_count,
        slide_size: section.settings.slide_height
      %}
    </div>
  {%- endif -%}


  {{ btw_groups }}

</div>

{% schema %}
{
  "name": "Slideshow (BTW)",
  "class": "container-background-image",
  "blocks": [
    {
      "type": "_slide"
    },
    {
      "type": "_btw-group"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "select",
      "id": "icons_style",
      "label": "t:settings.navigation",
      "options": [
        { "value": "arrow", "label": "t:options.arrows" },
        { "value": "chevron", "label": "t:options.chevrons" },
        { "value": "arrows_large", "label": "t:options.large_arrows" },
        { "value": "chevron_large", "label": "t:options.large_chevrons" },
        { "value": "none", "label": "t:options.none" }
      ],
      "default": "arrows_large"
    },
    {
      "type": "select",
      "id": "slideshow_controls_style",
      "label": "t:settings.pagination",
      "options": [
        { "value": "dots", "label": "t:options.dots" },
        { "value": "counter", "label": "t:options.counter" },
        { "value": "hide", "label": "t:options.hidden" }
      ],
      "default": "dots"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "t:settings.auto_rotate_slides",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "t:settings.speed",
      "min": 3,
      "max": 7,
      "step": 1,
      "unit": "s",
      "default": 4,
      "visible_if": "{{ section.settings.autoplay }}"
    },
    {
      "type": "header",
      "content": "t:content.size"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.width",
      "options": [
        { "value": "page-width", "label": "t:options.page" },
        { "value": "full-width", "label": "t:options.full" }
      ],
      "default": "full-width"
    },
    {
      "type": "select",
      "id": "slide_height",
      "options": [
        { "value": "auto", "label": "t:options.auto" },
        { "value": "small", "label": "t:options.small" },
        { "value": "medium", "label": "t:options.medium" },
        { "value": "large", "label": "t:options.large" },
        { "value": "full", "label": "t:options.full" }
      ],
      "default": "medium",
      "label": "t:settings.height"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.slideshow",
      "category": "01. BTW - Components",
      "blocks": {
        "slide_1": {
          "type": "_slide",
          "settings": {
            "horizontal_alignment_flex_direction_column": "center"
          },
          "blocks": {
            "group": {
              "type": "group",
              "settings": {
                "horizontal_alignment_flex_direction_column": "center",
                "width": "custom",
                "custom_width": 50,
                "width_mobile": "custom",
                "inherit_color_scheme": false,
                "color_scheme": "scheme-6",
                "custom_width_mobile": 85,
                "padding-inline-start": 48,
                "padding-inline-end": 48,
                "padding-block-start": 48,
                "padding-block-end": 48
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "settings": { "text": "t:html_defaults.new_arrivals_h2" }
                },
                "text": {
                  "type": "text",
                  "settings": {
                    "text": "t:html_defaults.latest_products",
                    "padding-block-end": 20
                  }
                },
                "button": {
                  "type": "button",
                  "settings": {
                    "label": "t:text_defaults.shop_now_button_label",
                    "link": "shopify://collections/all"
                  }
                }
              },
              "block_order": ["heading", "text", "button"]
            }
          },
          "block_order": ["group"]
        },
        "slide_2": {
          "type": "_slide",
          "settings": {
            "horizontal_alignment_flex_direction_column": "center"
          },
          "blocks": {
            "group": {
              "type": "group",
              "settings": {
                "horizontal_alignment_flex_direction_column": "center",
                "width": "custom",
                "custom_width": 50,
                "width_mobile": "custom",
                "inherit_color_scheme": false,
                "color_scheme": "scheme-6",
                "custom_width_mobile": 85,
                "padding-inline-start": 48,
                "padding-inline-end": 48,
                "padding-block-start": 48,
                "padding-block-end": 48
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "settings": { "text": "t:html_defaults.bestseller_h2" }
                },
                "text": {
                  "type": "text",
                  "settings": {
                    "text": "t:html_defaults.discover_bestsellers",
                    "padding-block-end": 20
                  }
                },
                "button": {
                  "type": "button",
                  "settings": {
                    "label": "t:text_defaults.shop_now_button_label",
                    "link": "shopify://collections/all"
                  }
                }
              },
              "block_order": ["heading", "text", "button"]
            }
          },
          "block_order": ["group"]
        }
      },
      "block_order": ["slide_1", "slide_2"]
    }
  ]
}
{% endschema %}
